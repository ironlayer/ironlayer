name: IronLayer CI/CD

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  schedule:
    # Weekly E2E: Monday 4 AM UTC
    - cron: '0 4 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  POETRY_VERSION: "1.7.1"

jobs:
  # ---------------------------------------------------------------------------
  # Lint: ruff, black, mypy across all Python packages
  # ---------------------------------------------------------------------------
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry==${{ env.POETRY_VERSION }}

      - name: Cache Poetry virtualenvs
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-lint-${{ hashFiles('**/poetry.lock', '**/pyproject.toml') }}
          restore-keys: ${{ runner.os }}-poetry-lint-

      - name: Install dependencies
        run: |
          cd core_engine && poetry install --no-interaction
          cd ../ai_engine && poetry install --no-interaction
          cd ../api && poetry install --no-interaction
          cd ../cli && poetry install --no-interaction

      - name: Lint with ruff
        run: |
          cd core_engine && poetry run ruff check core_engine/
          cd ../ai_engine && poetry run ruff check ai_engine/
          cd ../api && poetry run ruff check api/
          cd ../cli && poetry run ruff check cli/

      - name: Check formatting with black
        run: |
          cd core_engine && poetry run black --check core_engine/ tests/
          cd ../ai_engine && poetry run black --check ai_engine/ tests/
          cd ../api && poetry run black --check api/ tests/
          cd ../cli && poetry run black --check cli/ tests/

      - name: Run mypy (core_engine)
        run: cd core_engine && poetry run mypy core_engine/

      - name: Run mypy (ai_engine)
        run: cd ai_engine && poetry run mypy ai_engine/

      - name: Run mypy (api)
        run: cd api && poetry run mypy api/

      - name: Run mypy (cli)
        run: cd cli && poetry run mypy cli/

  # ---------------------------------------------------------------------------
  # Test: core engine (unit + integration with Postgres)
  # ---------------------------------------------------------------------------
  test-core:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: ironlayer_test
          POSTGRES_USER: ironlayer
          POSTGRES_PASSWORD: ironlayer_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry==${{ env.POETRY_VERSION }}

      - name: Cache Poetry virtualenvs
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-core-${{ hashFiles('core_engine/pyproject.toml', 'core_engine/poetry.lock') }}
          restore-keys: ${{ runner.os }}-poetry-core-

      - name: Install core engine
        run: cd core_engine && poetry install --no-interaction

      - name: Run unit tests
        run: cd core_engine && poetry run pytest tests/unit/ -v --cov=core_engine --cov-report=term-missing --cov-fail-under=60

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql+asyncpg://ironlayer:ironlayer_test@localhost:5432/ironlayer_test
        run: cd core_engine && poetry run pytest tests/integration/ -v

  # ---------------------------------------------------------------------------
  # Test: AI engine
  # ---------------------------------------------------------------------------
  test-ai:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry==${{ env.POETRY_VERSION }}

      - name: Cache Poetry virtualenvs
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-ai-${{ hashFiles('ai_engine/pyproject.toml', 'ai_engine/poetry.lock') }}
          restore-keys: ${{ runner.os }}-poetry-ai-

      - name: Install AI engine
        run: cd ai_engine && poetry install --no-interaction

      - name: Run tests
        run: cd ai_engine && poetry run pytest tests/ -v --cov=ai_engine --cov-report=term-missing --cov-fail-under=60

  # ---------------------------------------------------------------------------
  # Test: API
  # ---------------------------------------------------------------------------
  test-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry==${{ env.POETRY_VERSION }}

      - name: Cache Poetry virtualenvs
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-api-${{ hashFiles('api/pyproject.toml', 'api/poetry.lock', 'core_engine/pyproject.toml', 'core_engine/poetry.lock', 'ai_engine/pyproject.toml', 'ai_engine/poetry.lock') }}
          restore-keys: ${{ runner.os }}-poetry-api-

      - name: Install dependencies
        run: |
          cd core_engine && poetry install --no-interaction
          cd ../ai_engine && poetry install --no-interaction
          cd ../api && poetry install --no-interaction

      - name: Run tests
        run: cd api && poetry run pytest tests/ -v --cov=api --cov-report=term-missing --cov-fail-under=60

  # ---------------------------------------------------------------------------
  # Test: CLI
  # ---------------------------------------------------------------------------
  test-cli:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry==${{ env.POETRY_VERSION }}

      - name: Cache Poetry virtualenvs
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-cli-${{ hashFiles('cli/pyproject.toml', 'cli/poetry.lock', 'core_engine/pyproject.toml', 'core_engine/poetry.lock') }}
          restore-keys: ${{ runner.os }}-poetry-cli-

      - name: Install dependencies
        run: |
          cd core_engine && poetry install --no-interaction
          cd ../cli && poetry install --no-interaction

      - name: Run tests
        run: cd cli && poetry run pytest tests/ -v --cov=cli --cov-report=term-missing --cov-fail-under=60

  # ---------------------------------------------------------------------------
  # Test: Frontend (lint, typecheck, unit tests)
  # ---------------------------------------------------------------------------
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: Audit npm dependencies
        run: cd frontend && npm audit --audit-level=high

      - name: Lint
        run: cd frontend && npm run lint

      - name: Type check
        run: cd frontend && npx tsc --noEmit

      - name: Run tests with coverage
        run: cd frontend && npx vitest run --coverage

      - name: Check coverage threshold
        run: |
          cd frontend
          COVERAGE=$(node -e "
            const report = require('./coverage/coverage-summary.json');
            const pct = report.total.lines.pct;
            console.log(pct);
          ")
          echo "Line coverage: ${COVERAGE}%"
          node -e "if (${COVERAGE} < 20) { console.error('Coverage ${COVERAGE}% is below 20% threshold'); process.exit(1); }"

  # ---------------------------------------------------------------------------
  # Planner determinism gate -- core platform invariant
  # Same inputs MUST produce identical plan JSON (no timestamps, sorted
  # keys, content-based IDs).
  # ---------------------------------------------------------------------------
  planner-determinism:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry==${{ env.POETRY_VERSION }}

      - name: Cache Poetry virtualenvs
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-determinism-${{ hashFiles('core_engine/pyproject.toml', 'core_engine/poetry.lock') }}
          restore-keys: ${{ runner.os }}-poetry-determinism-

      - name: Install core engine
        run: cd core_engine && poetry install --no-interaction

      - name: Run planner determinism tests
        run: |
          cd core_engine && poetry run pytest \
            tests/unit/test_interval_planner.py::TestDeterminism \
            tests/unit/test_plan_serializer.py::TestSerializePlan::test_deterministic_output \
            tests/unit/test_plan_serializer.py::TestSerializePlan::test_keys_are_sorted \
            tests/integration/test_planner_determinism.py \
            -v --tb=short

  # ---------------------------------------------------------------------------
  # Test: E2E full pipeline (weekly schedule + release tags only)
  # ---------------------------------------------------------------------------
  test-e2e:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || startsWith(github.ref, 'refs/tags/v')
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: ironlayer_e2e
          POSTGRES_USER: ironlayer
          POSTGRES_PASSWORD: ironlayer_e2e
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry==${{ env.POETRY_VERSION }}

      - name: Cache Poetry virtualenvs
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-e2e-${{ hashFiles('core_engine/pyproject.toml', 'core_engine/poetry.lock', 'api/pyproject.toml', 'api/poetry.lock', 'ai_engine/pyproject.toml', 'ai_engine/poetry.lock') }}
          restore-keys: ${{ runner.os }}-poetry-e2e-

      - name: Install dependencies
        run: |
          cd core_engine && poetry install --no-interaction
          cd ../ai_engine && poetry install --no-interaction
          cd ../api && poetry install --no-interaction

      - name: Run E2E tests
        env:
          DATABASE_URL: postgresql+asyncpg://ironlayer:ironlayer_e2e@localhost:5432/ironlayer_e2e
        run: cd core_engine && poetry run pytest tests/e2e/ -v --tb=short

  # ---------------------------------------------------------------------------
  # Test: Root integration tests (failure recovery, cross-package)
  # ---------------------------------------------------------------------------
  test-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry==${{ env.POETRY_VERSION }}

      - name: Cache Poetry virtualenvs
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-integration-${{ hashFiles('core_engine/pyproject.toml', 'core_engine/poetry.lock', 'api/pyproject.toml', 'api/poetry.lock') }}
          restore-keys: ${{ runner.os }}-poetry-integration-

      - name: Install dependencies
        run: |
          cd core_engine && poetry install --no-interaction
          cd ../ai_engine && poetry install --no-interaction
          cd ../api && poetry install --no-interaction

      - name: Run integration tests
        run: |
          cd api && poetry run pytest ../tests/integration/ -v --tb=short

  # ---------------------------------------------------------------------------
  # Security scanning (pip-audit, Trivy, Bandit)
  # ---------------------------------------------------------------------------
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry==${{ env.POETRY_VERSION }}

      - name: Install dependencies
        run: |
          cd core_engine && poetry install --no-interaction
          cd ../ai_engine && poetry install --no-interaction
          cd ../api && poetry install --no-interaction

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Scan core_engine dependencies
        run: cd core_engine && pip-audit --desc

      - name: Scan api dependencies
        run: cd api && pip-audit --desc

      - name: Scan ai_engine dependencies
        run: cd ai_engine && pip-audit --desc

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: .
          format: table
          exit-code: '1'
          severity: CRITICAL,HIGH
          trivyignores: .trivyignore

      - name: Install bandit
        run: pip install bandit[toml]

      - name: Run bandit security scan
        run: bandit -r core_engine/core_engine api/api ai_engine/ai_engine -c pyproject.toml -f json -o bandit-report.json --severity-level medium || true

      - name: Upload bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json

      - name: Check bandit (fail on high severity)
        run: bandit -r core_engine/core_engine api/api ai_engine/ai_engine -c pyproject.toml --severity-level high

  # ---------------------------------------------------------------------------
  # Build & push Docker images to Azure Container Registry
  # Requires ALL gates: lint, tests, determinism, security
  # ---------------------------------------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    needs: [lint, test-core, test-ai, test-api, test-cli, test-frontend, test-integration, test-e2e, planner-determinism, security-scan]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write
      contents: read
    env:
      ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER }}

    strategy:
      matrix:
        include:
          - image: ironlayer-api
            dockerfile: infra/docker/Dockerfile.api
            context: .
          - image: ironlayer-ai
            dockerfile: infra/docker/Dockerfile.ai
            context: .
          - image: ironlayer-frontend
            dockerfile: infra/docker/Dockerfile.frontend
            context: .

    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to Azure Container Registry
        run: az acr login --name "${{ env.ACR_LOGIN_SERVER }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.image }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.image }}-

      - name: Determine image tags
        id: tags
        run: |
          TAGS="${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:sha-${GITHUB_SHA::8}"
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="${TAGS},${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:latest"
          fi
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            TAGS="${TAGS},${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:${VERSION}"
          fi
          echo "tags=${TAGS}" >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          platforms: linux/amd64
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            BUILD_SHA=${{ github.sha }}
            BUILD_REF=${{ github.ref }}
            VITE_API_URL=${{ vars.VITE_API_URL || 'https://api.ironlayer.app' }}

      - name: Rotate cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  # ---------------------------------------------------------------------------
  # Deploy to Azure Container Apps (release tags only)
  # ---------------------------------------------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write
      contents: read
    env:
      ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER }}
      RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}

    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Extract version tag
        id: version
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Run database migrations
        run: |
          az containerapp job update \
            --name ${{ vars.APP_PREFIX }}-migrate \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image "${{ env.ACR_LOGIN_SERVER }}/ironlayer-api:${{ steps.version.outputs.tag }}" \
            --output none
          az containerapp job start \
            --name ${{ vars.APP_PREFIX }}-migrate \
            --resource-group ${{ env.RESOURCE_GROUP }}

      - name: Deploy API
        run: |
          az containerapp update \
            --name ${{ vars.APP_PREFIX }}-api \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image "${{ env.ACR_LOGIN_SERVER }}/ironlayer-api:${{ steps.version.outputs.tag }}"

      - name: Deploy AI Engine
        run: |
          az containerapp update \
            --name ${{ vars.APP_PREFIX }}-ai \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image "${{ env.ACR_LOGIN_SERVER }}/ironlayer-ai:${{ steps.version.outputs.tag }}"

      - name: Deploy Frontend
        run: |
          az containerapp update \
            --name ${{ vars.APP_PREFIX }}-frontend \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image "${{ env.ACR_LOGIN_SERVER }}/ironlayer-frontend:${{ steps.version.outputs.tag }}"

      - name: Verify deployments
        run: |
          MAX_ATTEMPTS=12
          SLEEP_INTERVAL=10
          for APP in ${{ vars.APP_PREFIX }}-api ${{ vars.APP_PREFIX }}-ai ${{ vars.APP_PREFIX }}-frontend; do
            echo "--- Waiting for ${APP} to become healthy ---"
            for i in $(seq 1 $MAX_ATTEMPTS); do
              STATUS=$(az containerapp show \
                --name "${APP}" \
                --resource-group "${{ env.RESOURCE_GROUP }}" \
                --query "properties.runningStatus" \
                --output tsv 2>/dev/null || echo "Unknown")
              ACTIVE_REVISIONS=$(az containerapp revision list \
                --name "${APP}" \
                --resource-group "${{ env.RESOURCE_GROUP }}" \
                --query "[?properties.active].name" \
                --output tsv 2>/dev/null || echo "")
              if [ -n "$ACTIVE_REVISIONS" ] && [ "$STATUS" = "Running" ]; then
                echo "${APP} is healthy (attempt ${i}/${MAX_ATTEMPTS})"
                break
              fi
              if [ "$i" = "$MAX_ATTEMPTS" ]; then
                echo "ERROR: ${APP} did not become healthy after $((MAX_ATTEMPTS * SLEEP_INTERVAL))s"
                az containerapp revision list \
                  --name "${APP}" \
                  --resource-group "${{ env.RESOURCE_GROUP }}" \
                  --output table
                exit 1
              fi
              echo "Attempt ${i}/${MAX_ATTEMPTS}: ${APP} status=${STATUS}, retrying in ${SLEEP_INTERVAL}s..."
              sleep $SLEEP_INTERVAL
            done
          done

      - name: Smoke test API health
        run: |
          API_URL="https://api.ironlayer.app"
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' "${API_URL}/api/v1/health" || true)
            if [ "$STATUS" = "200" ]; then
              echo "API health check passed (attempt ${i})"
              exit 0
            fi
            echo "Attempt ${i}: got HTTP ${STATUS}, retrying in 10s..."
            sleep 10
          done
          echo "API health check failed after 5 attempts"
          exit 1

  # ---------------------------------------------------------------------------
  # Publish CLI wheel + OpenAPI spec (release tags only)
  # ---------------------------------------------------------------------------
  publish:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry==${{ env.POETRY_VERSION }}

      - name: Build CLI wheel
        run: cd cli && poetry build

      - name: Install API dependencies
        run: |
          cd api && poetry install --only main --no-interaction

      - name: Export OpenAPI spec
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          cd api
          poetry run python -c "
          import json
          from api.main import app
          spec = app.openapi()
          with open('openapi.json', 'w') as f:
              json.dump(spec, f, indent=2)
          "

      - name: Extract version
        id: version
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: IronLayer ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          files: |
            cli/dist/*.whl
            cli/dist/*.tar.gz
            api/openapi.json
