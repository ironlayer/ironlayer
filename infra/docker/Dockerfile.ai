FROM python:3.11-slim AS builder

COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

WORKDIR /build

# Copy workspace root config + lockfile (uv needs full workspace graph)
COPY pyproject.toml uv.lock /build/
COPY ai_engine/pyproject.toml /build/ai_engine/pyproject.toml
COPY core_engine/pyproject.toml /build/core_engine/pyproject.toml
COPY api/pyproject.toml /build/api/pyproject.toml
COPY cli/pyproject.toml /build/cli/pyproject.toml

# Copy source code needed for the build
COPY ai_engine/ai_engine/ /build/ai_engine/ai_engine/

# Create stub packages for workspace members not needed at runtime
RUN mkdir -p /build/core_engine/core_engine && touch /build/core_engine/core_engine/__init__.py && \
    mkdir -p /build/api/api && touch /build/api/api/__init__.py && \
    mkdir -p /build/cli/cli && touch /build/cli/cli/__init__.py

# Install only production dependencies for ai_engine
ENV UV_SYSTEM_PYTHON=1
RUN uv sync --package ai-engine --no-dev --frozen

FROM python:3.11-slim AS runtime

RUN groupadd -r ironlayer && useradd -r -g ironlayer -d /app ironlayer

COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

WORKDIR /app

COPY ai_engine/ai_engine/ /app/ai_engine/

USER ironlayer

EXPOSE 8001

CMD ["uvicorn", "ai_engine.main:app", "--host", "0.0.0.0", "--port", "8001"]
